# Core Routing - AI Implementation Plan

<!-- Generated by AI and reviewed by human -->

## Overview

Implement go_router with Riverpod-based authentication to handle routing between login and home screens. Use shared_preferences for local persistence of login state.

**Flow:**
- App starts → Check `isLoggedIn` from SharedPreferences
- If logged in → Navigate to home (or deep link destination)
- If not logged in → Redirect to login
- On login success → Save state, navigate to home

## Implementation Steps

### 1. Create Local DB Service (Core Layer)

**File:** `lib/core/services/local_db/local_db_service.dart`
- Generic wrapper around SharedPreferences
- Store everything as String (booleans, numbers, JSON objects)
- Methods:
  - `saveByKey(String key, String value)` - save value
  - `getByKey(String key)` - get value (returns String?)
  - `clearAll()` - clear all data
- Provider: `localDbServiceProvider`
- **No business logic** - fully reusable by any feature

### 2. Create Auth Data Layer

**Files:**
- `lib/features/auth/data/datasources/local/auth_local_datasource.dart`
  - Uses generic `LocalDbService` to save/retrieve auth state
  - Defines key: `'isLoggedIn'`
  - Methods: `saveLoginState(bool)`, `getLoginState()`, `clearLoginState()`
  - **This is where auth-specific storage logic lives**

- `lib/features/auth/data/repositories/auth_repository_impl.dart`
  - Implements auth business logic
  - Method: `login(email, password)` - validates hardcoded credentials (alice@gmail.com / 123456)
  - Method: `logout()` - clears state via datasource
  - Method: `isLoggedIn()` - checks state via datasource

### 3. Create Auth Providers (Riverpod)

**File:** `lib/features/auth/presentation/viewmodel/notifiers/auth_notifier.dart`
- `authRepositoryProvider` - provides AuthRepository instance
- `authNotifierProvider` - AsyncNotifierProvider<bool> for isLoggedIn
  - Exposes: `login(email, password)`, `logout()`, `checkAuthState()`
  - Uses `@riverpod` code generation

### 4. Create Router Configuration

**File:** `lib/core/routing/routing.dart`
- `routerProvider` - creates GoRouter with Riverpod integration
- Routes:
  - `/` → HomeScreen
  - `/login` → LoginScreen
- Redirect logic:
  - Check `authNotifierProvider` state
  - If not logged in + not on `/login` → redirect to `/login`
  - If logged in + on `/login` → redirect to `/`

### 5. Create Home Screen

**File:** `lib/features/home/presentation/screens/home_screen.dart`
- Blank scaffold with AppBar
- "Home" title
- Logout button (calls `ref.read(authNotifierProvider.notifier).logout()`)

### 6. Update Main.dart

- Remove `LoginScreen` from `home` parameter
- Use `MaterialApp.router` with `routerConfig: ref.watch(routerProvider)`
- Keep ProviderScope wrapper

### 7. Refactor Login Form

**File:** `lib/features/auth/presentation/widgets/login_form.dart`
- Remove `onSignIn`, `onSignUp` callback parameters
- Convert to `HookConsumerWidget`
- Use hooks: `useTextEditingController()` for email/password, `useState()` for obscure password
- Use `ref.read(authNotifierProvider.notifier).login(email, password)` directly
- Handle AsyncValue states (loading, error)
- Show SnackBar on error
- **Why HookConsumerWidget?**
  - ✅ Less boilerplate (no State class needed)
  - ✅ Auto-dispose controllers (no manual dispose)
  - ✅ Cleaner code with hooks
  - ✅ Already have `hooks_riverpod` in pubspec.yaml

**File:** `lib/features/auth/presentation/screens/login_screen.dart`
- Remove callback handlers (`_handleSignIn`, `_handleSignUp`)
- Pass no callbacks to mobile/web widgets

**Files:** `mobile/login_screen_mobile.dart`, `web/login_screen_web.dart`
- Remove `onSignIn`, `onSignUp` parameters

## Files to Create/Modify

| File                                                                 | Action | Description                               |
|----------------------------------------------------------------------|--------|-------------------------------------------|
| `core/services/local_db/local_db_service.dart`                                | Create | SharedPreferences wrapper                 |
| `features/auth/data/datasources/local/auth_local_datasource.dart`          | Create | Local data source for auth state          |
| `features/auth/data/repositories/auth_repository_impl.dart`          | Create | Auth repository implementation            |
| `features/auth/presentation/viewmodel/notifiers/auth_notifier.dart`  | Create | Riverpod auth state notifier              |
| `core/routing/routing.dart`                                          | Create | GoRouter configuration with auth redirect |
| `features/home/presentation/screens/home_screen.dart`                | Create | Blank home screen with logout             |
| `lib/main.dart`                                                      | Modify | Use MaterialApp.router                    |
| `features/auth/presentation/widgets/login_form.dart`                 | Modify | Remove callbacks, use Riverpod directly   |
| `features/auth/presentation/screens/login_screen.dart`               | Modify | Remove callback handlers                  |
| `features/auth/presentation/widgets/mobile/login_screen_mobile.dart` | Modify | Remove callback parameters                |
| `features/auth/presentation/widgets/web/login_screen_web.dart`       | Modify | Remove callback parameters                |

## Architecture Details

### Clean Architecture Flow

```
Presentation (UI) → ViewModel (Notifier) → Repository → DataSource → Service
                                                                        ↓
                                                              SharedPreferences
```

### Riverpod Provider Chain

```
localDbServiceProvider (SharedPreferences wrapper)
    ↓
authLocalDatasourceProvider (uses LocalDbService)
    ↓
authRepositoryProvider (business logic)
    ↓
authNotifierProvider (AsyncNotifier<bool>)
    ↓
routerProvider (GoRouter with redirect)
```

**Note:** See `AGENTS.md` → Code Patterns section for implementation examples.


## Dependencies

Already in pubspec.yaml:
- `go_router` - Need to add (run `flutter pub add go_router`)
- `hooks_riverpod` ✓
- `riverpod_annotation` ✓
- `shared_preferences` ✓


## Build Runner

After creating providers, run:
```bash
dart run build_runner build --delete-conflicting-outputs
```


## Notes

- Using `@riverpod` code generation for all providers
- Using `HookConsumerWidget` instead of `ConsumerStatefulWidget` for less boilerplate
- `LocalDbService` is fully generic - stores everything as String
  - Booleans stored as "true"/"false"
  - Numbers converted to strings
  - Objects can be JSON-encoded strings in the future
- Auth-specific logic (key: `'isLoggedIn'`) lives in `AuthLocalDatasource`, not in the service
- No sign-up functionality (scope limited to login/logout)
- Home screen is intentionally blank (will be built later)
- Keep clean architecture intact - no shortcuts
- Follow DRY and YAGNI principles
