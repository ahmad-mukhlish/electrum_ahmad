# Auth Backend Integration - AI Implementation Plan

<!-- Generated by AI and reviewed by human -->

## Overview

Integrate Firebase Authentication with the existing auth feature to enable real user registration and sign-in functionality. The implementation maintains clean architecture patterns by adding a Firebase datasource layer while keeping the existing auth structure intact. User data will be persisted locally using SharedPreferences as a cache, while Firebase handles the actual authentication session.

## Current State Analysis

**Existing Structure:**
- Auth Notifier manages auth state (login/logout)
- Auth Repository with hardcoded credentials
- Auth Local Datasource saves boolean login state
- Complete Login UI with email/password fields
- Router configured with go_router for auth-based redirects
- Home screen with basic logout functionality

**What's Missing:**
- User entity and DTO for user data modeling
- Firebase datasource for real authentication
- Register functionality (UI + business logic)
- User profile data persistence
- Firebase-specific error handling

## Implementation Steps

### Phase 1: Data Models

#### 1.1 Create User Entity (Domain Layer)
**File**: `lib/features/auth/domain/entities/user.dart`
- Define immutable User entity using freezed
- Fields: `uid`, `email`, `displayName`, `photoUrl`
- No external dependencies (pure domain model)

#### 1.2 Create User DTO (Data Layer)
**File**: `lib/features/auth/data/dtos/user_dto.dart`
- Define UserDto with json_serializable
- Fields: `uid`, `email`, `displayName`, `photoUrl`
- Add `fromJson/toJson` for SharedPreferences serialization
- Add `fromEntity/toEntity` conversion methods

### Phase 2: Firebase Integration

#### 2.1 Create Firebase Service Provider
**File**: `lib/core/services/firebase/firebase_service.dart`
- Create Riverpod provider for `FirebaseAuth.instance`
- Create Riverpod provider for `FirebaseFirestore.instance`
- These become the single source for Firebase instances

#### 2.2 Create Firebase Auth Datasource
**File**: `lib/features/auth/data/datasources/firestore/auth_firebase_datasource.dart`
- Implement `signInWithEmailAndPassword(email, password)` → returns UserDto
- Implement `signUpWithEmailAndPassword(email, password, displayName)` → returns UserDto
- Implement `signOut()`
- Implement `getCurrentUser()` → returns UserDto 
- Handle FirebaseAuthException with specific error mappings:
  - `email-already-in-use` → "already registered please login"
  - `user-not-found` → "not registered yet, please sign up"
  - `wrong-password` → "not registered yet, please sign up"
  - `invalid-email` → "Invalid email address"
  - `weak-password` → "Password too weak"

#### 2.3 Enhance Local Datasource
**File**: `lib/features/auth/data/datasources/local/auth_local_datasource.dart`
- Add `saveUser(UserDto)` to persist user JSON
- Add `getUser()` to retrieve UserDto
- Add `clearUser()` to remove user data
- Keep existing `saveLoginState/getLoginState` methods

### Phase 3: Repository Layer Updates

#### 3.1 Update Auth Repository Interface
**File**: `lib/features/auth/domain/repositories/auth_repository.dart`
- Add `Future<bool> register(String email, String password, String displayName)`
- Add `Future<User?> getUser()`
- **Remove `Future<bool> isLoggedIn()`** - no longer needed (YAGNI: replaced by `getUser() != null`)

#### 3.2 Update Auth Repository Implementation
**File**: `lib/features/auth/data/repositories/auth_repository_impl.dart`
- Inject `AuthFirebaseDatasource` alongside local datasource
- Update `login()`:
  - Call Firebase signIn
  - Save UserDto locally
  - Save login state (optional: can keep for backward compatibility or remove)
- Add `register()`:
  - Call Firebase signUp
  - Save UserDto locally
  - Save login state (optional: can keep for backward compatibility or remove)
- Update `logout()`:
  - Call Firebase signOut
  - Clear local user data
  - Clear login state
- **Remove `isLoggedIn()` implementation** entirely
- Add `getUser()` to retrieve User from local datasource (convert UserDto to User entity)

### Phase 4: State Management Updates

#### 4.1 Update Auth Notifier
**File**: `lib/features/auth/presentation/viewmodel/notifiers/auth_notifier.dart`
- Change state from `AsyncValue<bool>` to `AsyncValue<User?>`
- Update `build()` to return `User?` via `repo.getUser()`
- Update `login()` to fetch User after successful login
- Add `register(email, password, displayName)` method
- Update `logout()` to return null state
- Consider invalidating Firebase providers if needed

### Phase 5: Registration UI

#### 5.1 Create Register Form
**File**: `lib/features/auth/presentation/widgets/shared/register_form.dart`
- Create HookConsumerWidget following LoginForm pattern
- Fields: displayName, email, password
- Sign up button calling `authNotifier.register()`
- Link to navigate back to login
- Use `_build*` methods for UI organization
- Listen to auth state for error handling with SnackBar

#### 5.2 Create Register Screen
**File**: `lib/features/auth/presentation/screens/register_screen.dart`
- Wrap RegisterForm similar to LoginScreen structure
- Support mobile layout (web if needed)

### Phase 6: UI Updates

#### 6.1 Update Login Form Sign-Up Link
**File**: `lib/features/auth/presentation/widgets/shared/login_form.dart`
- Replace `_buildSignUpLink()` Text+GestureDetector with OutlinedButton
- Navigate to '/register' using `context.go('/register')`
- Maintain theme consistency with `colorScheme`

#### 6.2 Update Home Screen
**File**: `lib/features/home/presentation/screens/home_screen.dart`
- Watch `authProvider` to get User data
- Display user info:
  - CircleAvatar with photo (or placeholder if null)
  - Display name (fallback to email)
  - Email
- Handle AsyncValue loading/error states
- Keep logout button

### Phase 7: Routing

#### 7.1 Update Routing for User State
**File**: `lib/core/routing/routing.dart`
- **Update listener type**: Change `ref.listen<AsyncValue<bool>>` to `ref.listen<AsyncValue<User?>>`
- **Update ValueNotifier type**: Change `ValueNotifier<AsyncValue<bool>>` to `ValueNotifier<AsyncValue<User?>>`
- **Update isLoggedIn check**: Change `authState.value ?? false` to `authState.value != null`
- **Add `/register` route** to routes list
- **Update redirect logic** to allow both `/login` and `/register` when not logged in:
  - Change `final isLoginRoute = state.matchedLocation == '/login'`
  - To check for both: `final isAuthRoute = state.matchedLocation == '/login' || state.matchedLocation == '/register'`
  - Update condition: `if (!isLoggedIn && !isAuthRoute)` instead of `if (!isLoggedIn && !isLoginRoute)`
  - Update condition: `if (isLoggedIn && isAuthRoute)` instead of `if (isLoggedIn && isLoginRoute)`

### Phase 8: Code Generation

Run build_runner to generate all required code:
- Freezed models (.freezed.dart files)
- Riverpod providers (.g.dart files)
- JSON serialization (.g.dart files)

Command: `dart run build_runner build --delete-conflicting-outputs`

## Data Flow Diagrams

**Register Flow:**
```
RegisterForm → AuthNotifier.register()
  → Repository.register()
  → FirebaseDatasource.signUp()
  → [Firebase creates account]
  → Repository saves UserDto locally
  → AuthNotifier state updates to User
  → Router redirects to home
  → HomeScreen shows user info
```

**Sign-in Flow:**
```
LoginForm → AuthNotifier.login()
  → Repository.login()
  → FirebaseDatasource.signIn()
  → [Firebase authenticates]
  → Repository saves UserDto locally
  → AuthNotifier state updates to User
  → Router redirects to home
  → HomeScreen shows user info
```

**Sign-out Flow:**
```
HomeScreen logout button → AuthNotifier.logout()
  → Repository.logout()
  → FirebaseDatasource.signOut()
  → Repository clears local data
  → AuthNotifier state updates to null
  → Router redirects to login
```

**App Launch Flow:**
```
App starts → AuthNotifier.build()
  → Repository.getUser()
  → LocalDatasource returns cached User or null
  → Router redirects based on state
```

## Files to Create

1. `lib/features/auth/domain/entities/user.dart` - Domain user entity
2. `lib/features/auth/data/dtos/user_dto.dart` - Data transfer object with JSON
3. `lib/core/services/firebase/firebase_service.dart` - Firebase instance providers
4. `lib/features/auth/data/datasources/firestore/auth_firebase_datasource.dart` - Firebase auth operations
5. `lib/features/auth/presentation/widgets/shared/register_form.dart` - Registration form widget
6. `lib/features/auth/presentation/screens/register_screen.dart` - Registration screen

## Files to Modify

1. `lib/features/auth/data/datasources/local/auth_local_datasource.dart` - Add user persistence methods
2. `lib/features/auth/domain/repositories/auth_repository.dart` - Add register/getUser methods, remove isLoggedIn
3. `lib/features/auth/data/repositories/auth_repository_impl.dart` - Integrate Firebase datasource, remove isLoggedIn
4. `lib/features/auth/presentation/viewmodel/notifiers/auth_notifier.dart` - Change state to User?
5. `lib/features/auth/presentation/widgets/shared/login_form.dart` - Update sign-up link to button
6. `lib/features/home/presentation/screens/home_screen.dart` - Display user information
7. `lib/core/routing/routing.dart` - Update types to User?, add register route, update redirect logic

## Dependencies

All required dependencies are already in `pubspec.yaml`:
- `firebase_core: ^4.2.1` ✓
- `firebase_auth: ^6.1.2` ✓
- `cloud_firestore: ^6.1.0` ✓
- `shared_preferences: ^2.5.3` ✓
- `freezed_annotation: ^3.1.0` ✓
- `json_annotation: ^4.9.0` ✓
- `hooks_riverpod: ^3.0.3` ✓
- `go_router: ^17.0.0` ✓

Dev dependencies:
- `build_runner: ^2.7.1` ✓
- `freezed: ^3.2.3` ✓
- `json_serializable: ^6.11.2` ✓
- `riverpod_generator: ^3.0.3` ✓

## Key Design Decisions

**State Type Change:**
- AuthNotifier state changes from `AsyncValue<bool>` to `AsyncValue<User?>`
- This impacts routing.dart in multiple places:
  - Listener type: `ref.listen<AsyncValue<bool>>` → `ref.listen<AsyncValue<User?>>`
  - ValueNotifier type: `ValueNotifier<AsyncValue<bool>>` → `ValueNotifier<AsyncValue<User?>>`
  - isLoggedIn check: `authState.value ?? false` → `authState.value != null`
- More expressive state: loading, error, or User/null data
- Provides user data throughout the app via authProvider

**Removing isLoggedIn() Method (YAGNI):**
- Original repository had `isLoggedIn()` returning boolean
- With User-based state, `isLoggedIn()` is just `getUser() != null`
- Redundant method removed from repository contract and implementation
- Single source of truth: `getUser()` returns `User?`
- Routing checks `authState.value != null` instead of calling separate method
- Simpler repository API, less code to maintain
- Follows YAGNI (You Aren't Gonna Need It) and DRY (Don't Repeat Yourself) principles

**Local Storage Strategy:**
- SharedPreferences stores UserDto as JSON string
- Acts as cache for quick app startup
- Firebase manages the actual auth session
- On app restart, load from cache first, Firebase session persists automatically

**Error Handling:**
- Map Firebase error codes to requirement-specific messages
- Use SnackBar via `ref.listen` pattern already established
- Both register and login forms follow same error display approach

**Clean Architecture:**
- Domain entities remain pure (no Firebase/JSON dependencies)
- DTOs handle serialization concerns
- Repository abstracts Firebase implementation
- UI only knows about User entity, not Firebase or DTOs

**Conventions Adherence:**
- Use HookConsumerWidget consistently
- Fat arrow syntax for one-liners
- Pass minimal data (String, not controllers)
- UI organization with `_build*` methods
- Theme colors via `colorScheme`
