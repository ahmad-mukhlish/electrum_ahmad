# Electrum Ahmad

Flutter mobile application.

## Tech Stack

- Flutter 3.x
- Dart SDK ^3.9.2
- State management: Riverpod (2 skills available)
- Routing: go_router
- Primary datasource: Firebase Auth and Firestore

## Why Riverpod

- Pairs cleanly with `go_router`; avoids routing conflicts seen with GetX.
- Less boilerplate and ceremony than Bloc while staying explicit and testable.
- Keeps dependency injection light and composable as features grow.

## Why Firebase Auth and Firestore

- Chosen to focus on app architecture, UX, and state management without owning backend buildout.
- Data access is funneled through the data layer so another backend can be swapped later without touching other layers.

## AI-assisted workflow and per-feature docs

- Each feature/task is documented in the `documentations/` folder (separate from code) with:
    - `brief.md` → manual brief containing:
        - Context
        - Scope
        - Requirements
        - Clues
        - Keep in mind
    - `plan.md` → AI-assisted implementation plan
      (generated with Claude / other tools and then curated).
- Current auth tasks documented under `documentations/features/docs/`:
    - `slicing-ui/brief.md` and `slicing-ui/plan.md`
    - `integrate-be/brief.md` and `integrate-be/plan.md`
- Repeat this pattern for every big task: add a subfolder under `documentations/features/docs/` or `documentations/core/` with `brief.md` and `plan.md` before implementation.


## Project Structure (following clean architecture with MVVM pattern)

```
lib/
  core/
    routing/                    # GoRouter configuration
    services/                   # Group into subfolders when multiple files exist
      api/                      # API/Dio services
      firebase/                 # Firebase-related services
      local_db/                 # Local database services
      location/                 # Location services (use "location", not "location_platform")
    utils/                      # Helpers, Design tokens
    widgets/                    # Shared widgets
  features/
    auth/
      data/
        dtos/                   # JSON annotated dtos from datasources
        repositories/           # Implementation of domain repositories
        datasources/            # Data providers (Wrapper to API services / Local services)
      domain/
        entities/               # Business Entity (Model)
        repositories/           # Repository interfaces (contracts)
      presentation/
        viewmodel/
          notifiers/            # Notifiers (View model)
          states/               # Freezed UI states (if any)
        screens/                # Screen (View)
        widgets/
          mobile/               # Widgets tailored for mobile
          web/                  # Widgets tailored for web
          shared/               # Widgets shared between mobile and web
  main.dart                     # App entry point

documentations/                 # AI-assisted docs (separate from code)
  core/
    routing/
      brief.md                  # Context, Scope, Requirement, Clues, Keep in Mind
      plan.md                   # Generated by AI and reviewed by human
  features/
    auth/
      slicing-ui/
        brief.md                # Context, Scope, Requirement, Clues, Keep in Mind
        plan.md                 # Generated by AI and reviewed by human
      integrate-be/
        brief.md                # Context, Scope, Requirement, Clues, Keep in Mind
        plan.md                 # Generated by AI and reviewed by human
  references/                   # Design references, screenshots, etc.
```


## Commands

```bash
flutter run          # Run app
flutter test         # Run tests
flutter analyze      # Lint check
flutter build apk    # Build Android
flutter build ios    # Build iOS
```

## Conventions

- Skills stored in `.claude/skills`; use both available skills when applicable
- Firebase Auth + Firestore are used as the primary backend; keep access funneled through the data layer so other backends can be swapped in later if needed.
- AI-assisted development implementation: every big task keeps `documentations/<area>/<task>/brief.md` and `documentations/<area>/<task>/plan.md` (separate from code) so humans and AI share intent, maintain context across sessions, and minimize token usage.
- Design tokens (colors): use theme colors from `main.dart` via `Theme.of(context).colorScheme`, no hard codes
- use DRY and YAGNI principle
- **IMPORTANT: No hardcoded/magic values in UI** - Never display hardcoded text, numbers, or data that doesn't come from the actual entity/model. Examples:
  - ❌ Don't create fake feature lists like "Zero Emissions", "Smart Features" when no such field exists
  - ❌ Don't add placeholder data like "Lorem ipsum" or "Sample description"
  - ❌ Don't invent fields that aren't in the entity
  - ✅ Only display data that actually exists in the entity/model
  - ✅ If a field is empty/null, either hide that section or show an appropriate empty state
  - ✅ All displayed information must come from real data sources (entities, APIs, Firestore)
- avoid writing testing strategy at plan.md unless explicit mention at brief.md
- **IMPORTANT: NEVER write code in plan.md** - plan.md should only contain high-level descriptions, file structure, and implementation steps. Writing code in plan.md:
  - Wastes tokens (plan files can become thousands of lines)
  - Makes plans harder to read and navigate
  - Duplicates information (code will be written during implementation anyway)
  - Violates the purpose of planning (plans are for strategy, not implementation)
  - Instead: describe WHAT needs to be done, not HOW (no code examples, no full implementations)
- Never use `setState()` manually; prefer hooks and Riverpod for state.
- Using `HookConsumerWidget` instead of `ConsumerStatefulWidget` for less boilerplate
- When more than 2 lines, create a named function instead of nameless function / lambda
- **Pass only what you need**: Extract minimal data before passing to methods (e.g., pass `String` instead of `TextEditingController`, pass `ColorScheme` instead of `BuildContext`)
- **Omit unused parameters**: Use single underscore `_` for unused callback parameters (e.g., `(_, next)` instead of `(previous, next)` if previous is unused)
- always use fat arrow => for functions whenever possible especially one line function
- **Delegate build_runner and flutter analyze to user**: To reduce token usage, avoid running `dart run build_runner build` and `flutter analyze` unless explicitly requested. Instead, remind the user to run these commands manually after code changes that require code generation or when checking for lint issues
- **One UI class per file**: Never place multiple UI classes/widgets in a single file; keep each UI class in its own file to maintain clarity and reuse

### Color Usage

**IMPORTANT**: Always use `Theme.of(context).colorScheme` for colors. Never use `Colors.white`, `Colors.black`, or hardcoded color values.

**Rules:**
- ❌ Never use: `Colors.black`, `Colors.white`, `Color(0xFF...)` hardcoded values
- ✅ Always use: `colorScheme.onSecondary` (for black/dark colors)
- ✅ Always use: `colorScheme.onPrimary` (for white/light colors)
- ✅ Use semantic tokens: `colorScheme.primary`, `colorScheme.secondary`, `colorScheme.tertiary`, `colorScheme.error`

**Example:**
```dart
final colorScheme = Theme.of(context).colorScheme;

// Dark text (instead of Colors.black)
Text('Hello', style: TextStyle(color: colorScheme.onSecondary))

// Light background (instead of Colors.white)
Container(color: colorScheme.onPrimary)

// For muted states
color: colorScheme.onSecondary.withOpacity(0.6)
```

**Reference**: See `lib/main.dart` for the complete color palette definition.

### Responsive Text Sizing

**IMPORTANT**: Text sizes must be larger on web and smaller on mobile. Use conditional sizing based on platform.

**Pattern:**
```dart
import 'package:flutter/foundation.dart';

// Get text theme
final textTheme = Theme.of(context).textTheme;

// Apply responsive text size using kIsWeb
final titleStyle = kIsWeb ? textTheme.displayMedium : textTheme.headlineSmall;
final subtitleStyle = kIsWeb ? textTheme.headlineLarge : textTheme.bodyLarge;
final bodyStyle = kIsWeb ? textTheme.headlineSmall : textTheme.bodyLarge;
```

**Common Mappings:**
- **Large headings**: `kIsWeb ? textTheme.displayMedium : textTheme.headlineSmall`
- **Subheadings**: `kIsWeb ? textTheme.headlineLarge : textTheme.bodyLarge`
- **Body text**: `kIsWeb ? textTheme.headlineSmall : textTheme.bodyLarge`
- **Small text**: `kIsWeb ? textTheme.bodyLarge : textTheme.bodyMedium`

**Why this matters:**
- Web users typically sit further from screens
- Mobile users hold devices closer
- Maintains optimal readability across platforms
- Consistent with platform conventions

**Reference**: See `lib/features/auth/presentation/widgets/shared/auth_form.dart` for implementation examples (lines 103, 127-129, 300-308, 330).

### Error Handling in Data Layer

**All methods in datasources and repositories must use try-catch blocks with rethrow** to ensure proper error propagation through the data layer. This allows errors to bubble up to the presentation layer where they can be properly handled and displayed to users.

**Pattern:**
```dart
Future<UserDto> signInWithEmailAndPassword(
  String email,
  String password,
) async {
  try {
    final userCredential = await _firebaseAuth.signInWithEmailAndPassword(
      email: email,
      password: password,
    );

    return _userDtoFromFirebase(userCredential.user!);
  } catch (e) {
    rethrow;
  }
}
```

**Why this is important:**
- Ensures consistent error flow throughout the application
- Allows presentation layer to handle errors appropriately (show error messages, log errors, etc.)
- Makes debugging easier by preserving the original stack trace
- Maintains separation of concerns: data layer focuses on data operations, presentation layer handles user-facing error messages

**Apply this to:**
- All public methods in datasource classes
- All public methods in repository implementation classes
- Both async (Future) and sync methods that can throw errors

### Freezed Models (v3.0.0+)

**Important**: Freezed version 3.0.0 and above requires `sealed` or `abstract` modifier for classes using factory constructors. This is stated in the [V3 Migration Guide](https://pub.dev/packages/freezed#migration-guide).

**Correct Pattern:**
```dart
@freezed
abstract class User with _$User {
  const User._();

  const factory User({
    required String uid,
    required String email,
    String? displayName,
    String? photoUrl,
  }) = _User;
}
```

**Why this is needed:**
- Without `abstract` or `sealed`, Dart analyzer will show "Missing concrete implementations" errors
- The private constructor `const User._()` allows adding custom methods to Freezed classes
- After adding the modifier, run: `dart run build_runner build --delete-conflicting-outputs`

**Common patterns:**
- Use `abstract` for classes that may be extended
- Use `sealed` for closed type hierarchies (union types)
- Always include the private constructor if you need custom methods or extensions

### UI State Naming Convention

**Important**: When creating UI state classes (Freezed classes that extend domain entities with UI-specific data), use the suffix `State` instead of `UIState`.

**Correct Pattern:**
```dart
// Domain entity
@freezed
abstract class Plan with _$Plan {
  const Plan._();
  const factory Plan({
    required int id,
    required String name,
    // ... other fields
  }) = _Plan;
}

// UI State (NOT PlanUIState)
@freezed
abstract class PlanState with _$PlanState {
  const PlanState._();

  const factory PlanState({
    required Plan plan,
    required double percentageDiscount,
  }) = _PlanState;

  factory PlanState.fromEntity(Plan plan) {
    // Calculate UI-specific values
    return PlanState(
      plan: plan,
      percentageDiscount: _calculateDiscount(plan),
    );
  }
}
```

**Why this pattern:**
- If it's named `State`, it's clearly for UI purposes - no need for redundant `UI` prefix
- Shorter, cleaner names improve code readability
- Follows Flutter's own naming convention (e.g., `ButtonState`, not `ButtonUIState`)
- File names should match: `plan_state.dart`, not `plan_ui_state.dart`
- Provider names: `planStateProvider`, not `planUIStateProvider`

**Apply this to:**
- All UI state classes that extend domain entities
- Freezed classes used specifically for presentation layer
- Any state class that combines entity data with calculated UI values

### Data Transfer Objects (DTOs)

**Important**: DTOs should use `json_serializable` for JSON serialization, NOT Freezed. Freezed is reserved for domain entities only.

**Correct DTO Pattern:**
```dart
import 'package:json_annotation/json_annotation.dart';
import '../../domain/entities/user.dart';

part 'user_dto.g.dart';

@JsonSerializable()
class UserDto {
  final String? uid;
  final String? email;
  final String? displayName;
  final String? photoUrl;

  UserDto({
    this.uid,
    this.email,
    this.displayName,
    this.photoUrl,
  });

  factory UserDto.fromJson(Map<String, dynamic> json) =>
      _$UserDtoFromJson(json);

  Map<String, dynamic> toJson() => _$UserDtoToJson(this);
}

/// DTO to Entity mapper
extension UserDtoMapper on UserDto {
  /// Convert DTO to domain entity with default values
  User toEntity() => User(
        uid: uid ?? '',
        email: email ?? '',
        displayName: displayName,
        photoUrl: photoUrl,
      );
}
```

**In the Entity file** (`lib/features/auth/domain/entities/user.dart`):
```dart
import 'package:freezed_annotation/freezed_annotation.dart';
import '../../data/dtos/user_dto.dart';

part 'user.freezed.dart';

@freezed
abstract class User with _$User {
  const User._();

  const factory User({
    required String uid,
    required String email,
    String? displayName,
    String? photoUrl,
  }) = _User;
}

/// Entity to DTO mapper
extension UserMapper on User {
  UserDto toDto() => UserDto(
        uid: uid,
        email: email,
        displayName: displayName,
        photoUrl: photoUrl,
      );
}
```

**Why this pattern:**
- DTOs are data containers for serialization/deserialization only
- `json_serializable` provides efficient JSON conversion without Freezed overhead
- Domain entities use Freezed for immutability and value equality
- This separation keeps concerns clear: DTOs for data transport, entities for business logic
- Use `@JsonKey(name: 'field-name')` for field name mapping when API uses different naming

**DTO Nullable Fields Pattern:**
- All DTO fields should be nullable to handle incomplete data from external sources
- The mapper (`toEntity()`) provides default values when converting to entities
- Use `??` operator to provide defaults: `title: title ?? ''` for strings, etc.
- This makes DTOs resilient to missing data without throwing deserialization errors
- Default values should match the entity's expectations or business rules

**Mapper Extension Naming Convention:**
- Use `{Name}DtoMapper` for DTO-to-Entity conversion (e.g., `UserDtoMapper`)
  - Defined in the **DTO file** (`features/*/data/dtos/`)
- Use `{Name}Mapper` for Entity-to-DTO conversion (e.g., `UserMapper`)
  - Defined in the **Entity file** (`features/*/domain/entities/`)
- This separation prevents circular dependencies while keeping concerns organized
- This naming clearly indicates the mapping purpose and direction

**Apply this to:**
- All DTO classes in `features/*/data/dtos/` directories
- Any class that needs JSON serialization for API/Firestore communication

### UI Widget Organization

- **Separate widgets by their role using builder methods**
- Extract UI components into descriptive methods for better readability and maintainability

Example structure:
```dart
class MyWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        _buildHeader(),
        _buildContent(),
        _buildActionButtons(),
      ],
    );
  }

  Widget _buildHeader() {
    return Text('Header');
  }

  Widget _buildContent() {
    return Container(...);
  }

  Widget _buildActionButtons() {
    return Row(
      children: [
        _buildPrimaryButton(),
        _buildSecondaryButton(),
      ],
    );
  }

  Widget _buildPrimaryButton() {
    return FilledButton(...);
  }

  Widget _buildSecondaryButton() {
    return TextButton(...);
  }
}
```

**Benefits:**
- Cleaner code structure
- Easier to navigate and understand
- Simpler to modify individual sections
- Better code reusability within the widget

## Current `lib/` Structure

```
lib/
├── core/
│   ├── routing/
│   │   ├── routing.dart
│   │   └── routing.g.dart
│   ├── services/
│   │   ├── api/
│   │   │   ├── api_service.dart
│   │   │   └── api_service.g.dart
│   │   ├── firebase/
│   │   │   ├── firebase_service.dart
│   │   │   └── firebase_service.g.dart
│   │   ├── local_db/
│   │   │   ├── local_db_service.dart
│   │   │   └── local_db_service.g.dart
│   │   └── location/
│   │       ├── location_service.dart
│   │       └── location_service.g.dart
│   ├── utils/
│   │   ├── color_helper.dart
│   │   └── price_formatter.dart
│   └── widgets/
│       ├── header_web.dart
│       └── primary_app_bar.dart
├── features/
│   ├── auth/
│   │   ├── data/
│   │   │   ├── datasources/
│   │   │   │   ├── firestore/auth_firebase_datasource.dart
│   │   │   │   └── firestore/auth_firebase_datasource.g.dart
│   │   │   │   ├── local/auth_local_datasource.dart
│   │   │   │   └── local/auth_local_datasource.g.dart
│   │   │   ├── dtos/user_dto.dart
│   │   │   ├── dtos/user_dto.g.dart
│   │   │   ├── repositories/auth_repository_impl.dart
│   │   │   └── repositories/auth_repository_impl.g.dart
│   │   ├── domain/
│   │   │   ├── entities/user.dart
│   │   │   ├── entities/user.freezed.dart
│   │   │   └── repositories/auth_repository.dart
│   │   └── presentation/
│   │       ├── screens/auth_screen.dart
│   │       ├── viewmodel/notifiers/
│   │       │   ├── auth_notifier.dart
│   │       │   └── auth_notifier.g.dart
│   │       └── widgets/
│   │           ├── mobile/auth_screen_mobile.dart
│   │           ├── shared/auth_form.dart
│   │           └── web/auth_screen_web.dart
│   ├── bikes/
│   │   ├── data/
│   │   │   ├── datasources/bikes_firestore_datasource.dart
│   │   │   ├── datasources/bikes_firestore_datasource.g.dart
│   │   │   ├── dtos/bike_dto.dart
│   │   │   ├── dtos/bike_dto.g.dart
│   │   │   ├── repositories/bikes_repository_impl.dart
│   │   │   └── repositories/bikes_repository_impl.g.dart
│   │   ├── domain/
│   │   │   ├── entities/bike.dart
│   │   │   ├── entities/bike.freezed.dart
│   │   │   └── repositories/bikes_repository.dart
│   │   └── presentation/
│   │       ├── screens/
│   │       │   ├── bike_detail_screen.dart
│   │       │   └── bikes_screen.dart
│   │       ├── viewmodel/
│   │       │   ├── notifiers/detail/bike_detail_provider.dart
│   │       │   ├── notifiers/detail/bike_detail_provider.g.dart
│   │       │   ├── notifiers/filter/bike_filter_provider.dart
│   │       │   ├── notifiers/filter/bike_filter_provider.g.dart
│   │       │   ├── notifiers/stream/bikes_provider.dart
│   │       │   ├── notifiers/stream/bikes_provider.g.dart
│   │       │   ├── states/bike_filter_state.dart
│   │       │   ├── states/bike_filter_state.freezed.dart
│   │       │   └── states/filter_buckets.dart
│   │       └── widgets/
│   │           ├── mobile/
│   │           │   ├── active_filters_chips.dart
│   │           │   ├── bike_detail_content_mobile.dart
│   │           │   ├── bikes_filter_button.dart
│   │           │   ├── bikes_filter_sheet.dart
│   │           │   ├── bikes_list_mobile.dart
│   │           │   ├── bikes_list_with_filters_mobile.dart
│   │           │   └── bikes_search_bar.dart
│   │           ├── shared/
│   │           │   ├── availability_toggle.dart
│   │           │   ├── bike_card.dart
│   │           │   ├── bike_cta_button.dart
│   │           │   ├── bike_hero_section.dart
│   │           │   ├── bike_pickup_areas.dart
│   │           │   ├── bike_specs_row.dart
│   │           │   ├── price_bucket_selector.dart
│   │           │   └── range_bucket_selector.dart
│   │           └── web/
│   │               ├── bike_detail_content_web.dart
│   │               ├── bikes_filter_panel.dart
│   │               ├── bikes_list_web.dart
│   │               ├── bikes_list_with_filters_web.dart
│   │               └── bikes_search_field_web.dart
│   ├── home/
│   │   ├── data/
│   │   │   ├── datasources/
│   │   │   │   ├── plans/plans_firestore_datasource.dart
│   │   │   │   ├── plans/plans_firestore_datasource.g.dart
│   │   │   │   ├── promotions/promotions_firestore_datasource.dart
│   │   │   │   └── promotions/promotions_firestore_datasource.g.dart
│   │   │   ├── dtos/plans/plan_dto.dart
│   │   │   ├── dtos/plans/plan_dto.g.dart
│   │   │   ├── dtos/promotions/promotion_dto.dart
│   │   │   ├── dtos/promotions/promotion_dto.g.dart
│   │   │   ├── repositories/plans/plans_repository_impl.dart
│   │   │   ├── repositories/plans/plans_repository_impl.g.dart
│   │   │   ├── repositories/promotions/promotions_repository_impl.dart
│   │   │   └── repositories/promotions/promotions_repository_impl.g.dart
│   │   ├── domain/
│   │   │   ├── entities/plan/plan.dart
│   │   │   ├── entities/plan/plan.freezed.dart
│   │   │   ├── entities/plan/plan_period.dart
│   │   │   ├── entities/promotion/promotion.dart
│   │   │   ├── entities/promotion/promotion.freezed.dart
│   │   │   ├── repositories/plans_repository.dart
│   │   │   └── repositories/promotions_repository.dart
│   │   └── presentation/
│   │       ├── screens/home_screen.dart
│   │       ├── viewmodel/
│   │       │   ├── notifier/plan/plans_provider.dart
│   │       │   ├── notifier/plan/plans_state_provider.dart
│   │       │   ├── notifier/plan/plans_state_provider.g.dart
│   │       │   ├── notifier/plan/selected_period_provider.dart
│   │       │   ├── notifier/plan/selected_period_provider.g.dart
│   │       │   ├── notifier/promotion/promotions_provider.dart
│   │       │   └── notifier/promotion/promotions_provider.g.dart
│   │       ├── viewmodel/states/plan_state.dart
│   │       ├── viewmodel/states/plan_state.freezed.dart
│   │       └── widgets/
│   │           ├── mobile/
│   │           │   ├── home_content_mobile.dart
│   │           │   ├── period_toggle_section.dart
│   │           │   └── plans_section_mobile.dart
│   │           ├── shared/
│   │           │   ├── period_toggle.dart
│   │           │   ├── plan_card.dart
│   │           │   ├── plan_discount_badge.dart
│   │           │   ├── plan_pricing.dart
│   │           │   ├── promotion_card.dart
│   │           │   └── promotions_carousel.dart
│   │           └── web/
│   │               ├── home_content_web.dart
│   │               └── plans_section_web.dart
│   ├── main/
│   │   ├── domain/enum/main_nav_destination.dart
│   │   └── presentation/
│   │       ├── screens/main_screen.dart
│   │       ├── viewmodel/notifiers/navigation_notifier.dart
│   │       ├── viewmodel/notifiers/navigation_notifier.g.dart
│   │       └── widgets/
│   │           ├── mobile/main_screen_mobile.dart
│   │           └── web/main_screen_web.dart
│   ├── profile/
│   │   └── presentation/screens/profile_screen.dart
│   └── rents/
│       ├── data/
│       │   ├── datasources/
│       │   │   ├── location/location_remote_datasource.dart
│       │   │   ├── location/location_remote_datasource.g.dart
│       │   │   ├── rents/rents_firestore_datasource.dart
│       │   │   └── rents/rents_firestore_datasource.g.dart
│       │   ├── dtos/location/reverse_geocoding_response_dto.dart
│       │   ├── dtos/location/reverse_geocoding_response_dto.g.dart
│       │   ├── dtos/rents/rent_dto.dart
│       │   ├── dtos/rents/rent_dto.g.dart
│       │   ├── repositories/location/location_repository_impl.dart
│       │   ├── repositories/location/location_repository_impl.g.dart
│       │   ├── repositories/rents/rents_repository_impl.dart
│       │   └── repositories/rents/rents_repository_impl.g.dart
│       ├── domain/
│       │   ├── entities/location/location.dart
│       │   ├── entities/location/location.freezed.dart
│       │   ├── entities/rent/rent.dart
│       │   ├── entities/rent/rent.freezed.dart
│       │   ├── repositories/location_repository.dart
│       │   └── repositories/rents_repository.dart
│       └── presentation/
│           ├── screens/bike_renting_form_screen.dart
│           ├── viewmodel/notifiers/form/rent_form_provider.dart
│           ├── viewmodel/notifiers/form/rent_form_provider.g.dart
│           ├── viewmodel/notifiers/submit/rent_submit_provider.dart
│           ├── viewmodel/notifiers/submit/rent_submit_provider.g.dart
│           ├── viewmodel/states/rent_form_state.dart
│           ├── viewmodel/states/rent_form_state.freezed.dart
│           └── widgets/
│               ├── mobile/rent_form_content_mobile.dart
│               ├── shared/bike_summary_card.dart
│               ├── shared/contact_fields.dart
│               ├── shared/payment_summary_card.dart
│               ├── shared/pickup_location_field.dart
│               ├── shared/rental_period_fields.dart
│               ├── shared/submit_button.dart
│               └── web/rent_form_content_web.dart
├── firebase_options.dart
└── main.dart
```
